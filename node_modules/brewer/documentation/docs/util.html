<!DOCTYPE html>  <html> <head>   <title>util.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="brewfile.html">                 brewfile.coffee               </a>                                           <a class="source" href="command.html">                 command.coffee               </a>                                           <a class="source" href="coffee-script.html">                 coffee-script.coffee               </a>                                           <a class="source" href="css.html">                 css.coffee               </a>                                           <a class="source" href="iced-coffee-script.html">                 iced-coffee-script.coffee               </a>                                           <a class="source" href="javascript.html">                 javascript.coffee               </a>                                           <a class="source" href="less.html">                 less.coffee               </a>                                           <a class="source" href="stylus.html">                 stylus.coffee               </a>                                           <a class="source" href="file.html">                 file.coffee               </a>                                           <a class="source" href="index.html">                 index.coffee               </a>                                           <a class="source" href="package.html">                 package.coffee               </a>                                           <a class="source" href="project.html">                 project.coffee               </a>                                           <a class="source" href="source.html">                 source.coffee               </a>                                           <a class="source" href="util.html">                 util.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               util.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This modules exports a few functions used throughout 
<strong>brewer.js</strong>, and not specific to certain components, such
as calculating checksums, manipulating extensions and 
comparing mtime's.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_ = </span><span class="nx">require</span> <span class="s1">&#39;underscore&#39;</span>
<span class="nv">fs = </span><span class="nx">require</span> <span class="s1">&#39;fs&#39;</span>
<span class="nv">path = </span><span class="nx">require</span> <span class="s1">&#39;path&#39;</span>
<span class="p">{</span><span class="nx">debug</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./command&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>These two functions calculate the MD5 checksum of a
file or stream. The first one by synchronously reading
the whole content of a file (use sparingly), and the
second sets up a listener on a readable stream and
updates the hash as data comes in.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="vi">@checksumSync = </span><span class="nf">(path) -&gt;</span>
  <span class="nv">md5 = </span><span class="p">(</span><span class="nx">require</span> <span class="s1">&#39;crypto&#39;</span><span class="p">).</span><span class="nx">createHash</span> <span class="s1">&#39;md5&#39;</span>
  <span class="nx">md5</span><span class="p">.</span><span class="nx">update</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span> <span class="nx">path</span>
  <span class="nx">md5</span><span class="p">.</span><span class="nx">digest</span> <span class="s1">&#39;hex&#39;</span>

<span class="vi">@checksumStream = </span><span class="nf">(readStream, cb) -&gt;</span>
  <span class="nv">md5 = </span><span class="p">(</span><span class="nx">require</span> <span class="s1">&#39;crypto&#39;</span><span class="p">).</span><span class="nx">createHash</span> <span class="s1">&#39;md5&#39;</span>
  <span class="nx">readStream</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nf">(data) -&gt;</span> <span class="nx">md5</span><span class="p">.</span><span class="nx">update</span> <span class="nx">data</span>
  <span class="nx">readStream</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">cb</span> <span class="nx">md5</span><span class="p">.</span><span class="nx">digest</span> <span class="s1">&#39;hex&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>This function is used to recursively make all directories
leading to a path, by starting on the leaf node and climbing
until it reaches an existing directory. This is done to
avoid greediness.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="vi">@makedirs = </span><span class="nv">makedirs = </span><span class="nf">(fpath) -&gt;</span>
  <span class="nv">fpath = </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">fpath</span>
  <span class="nv">dir = </span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span> <span class="nx">fpath</span>
  <span class="nx">makedirs</span> <span class="nx">dir</span> <span class="nx">unless</span> <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">dir</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">mkdirSync</span> <span class="nx">fpath</span> <span class="nx">unless</span> <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">fpath</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>This function returns whether the given filename has the given
extension.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="vi">@hasext = </span><span class="nv">hasext = </span><span class="nf">(filename, ext) -&gt;</span>
  <span class="nx">path</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="o">==</span> <span class="nx">ext</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>This function returns a new version of the given filename, by
ensuring its extension is the given one.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="vi">@changeext = </span><span class="nv">changeext = </span><span class="nf">(filename, ext) -&gt;</span>
  <span class="k">return</span> <span class="nx">filename</span> <span class="k">if</span> <span class="nx">hasext</span> <span class="nx">filename</span><span class="p">,</span> <span class="nx">ext</span>
  <span class="k">return</span> <span class="s2">&quot;#{splitext(filename)[0]}#{ext}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>This function returns a array of two strings, given a filename: 
a basename and an extension.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="vi">@splitext = </span><span class="nv">splitext = </span><span class="nf">(filename) -&gt;</span>
  <span class="nv">ext = </span><span class="nx">path</span><span class="p">.</span><span class="nx">extname</span> <span class="nx">filename</span>
  <span class="nv">len = </span><span class="nx">filename</span><span class="p">.</span><span class="nx">length</span>
  <span class="k">return</span> <span class="p">[</span><span class="nx">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">len</span><span class="o">-</span><span class="nx">ext</span><span class="p">.</span><span class="nx">length</span><span class="p">],</span> <span class="nx">ext</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>This asynchronous function takes 2 files and a callback as 
arguments, and returns whether the first file can be considered
newer than the second. It first checks whether the first file 
exists, returning false if not. Then it does the same with the
second file, returning true if not. Then it checks stat.mtime
for both of the files and compares them. The callback style
follows Node.js convention of (error, value).</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="vi">@newer = </span><span class="nf">(file1, file2, cb) -&gt;</span>
  <span class="nx">path</span><span class="p">.</span><span class="nx">exists</span> <span class="nx">file1</span><span class="p">,</span> <span class="nf">(exists) -&gt;</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">exists</span>
    <span class="nx">path</span><span class="p">.</span><span class="nx">exists</span> <span class="nx">file2</span><span class="p">,</span> <span class="nf">(exists) -&gt;</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">exists</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">file1</span><span class="p">,</span> <span class="nf">(err, stats) -&gt;</span>
        <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
        <span class="nv">time1 = </span><span class="nx">stats</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">file2</span><span class="p">,</span> <span class="nf">(err, stats) -&gt;</span>
          <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
          <span class="nv">time2 = </span><span class="nx">stats</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span>
          <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">time1</span> <span class="o">&gt;</span> <span class="nx">time2</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>This function is a synchronous equivalent of the above function.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="vi">@newerSync = </span><span class="nf">(file1, file2) -&gt;</span>
  <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">file1</span>
  <span class="k">return</span> <span class="kc">true</span> <span class="nx">unless</span> <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">file2</span>
  <span class="nv">time1 = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">file1</span><span class="p">).</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span>
  <span class="nv">time2 = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">file2</span><span class="p">).</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span>
  <span class="k">return</span> <span class="nx">time1</span> <span class="o">&gt;</span> <span class="nx">time2</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>This asynchronous function takes a series of file and a callback
and returns whether the first of them can be considered the 
newest. It loops through all of them calling the <code>newer()</code> to
compare the first file with each, accumulating a boolean value
that gets returned when all files have been evaluated. </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="vi">@newest = </span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">others</span><span class="p">...,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
  <span class="nv">cnt = </span><span class="nx">others</span><span class="p">.</span><span class="nx">length</span>
  <span class="nv">newest = </span><span class="kc">true</span>
  <span class="nv">fail = </span><span class="kc">false</span>
  <span class="k">for</span> <span class="nx">otherFile</span> <span class="k">in</span> <span class="nx">others</span>
    <span class="nx">do</span> <span class="p">(</span><span class="nx">otherFile</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">fail</span>
      <span class="nx">@newer</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">otherFile</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">newer</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">return</span> <span class="k">if</span> <span class="nx">fail</span>
        <span class="k">return</span> <span class="p">(</span><span class="nv">fail = </span><span class="kc">true</span><span class="p">)</span> <span class="o">and</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span><span class="o">?</span>
        <span class="nx">newest</span> <span class="o">&amp;&amp;=</span> <span class="nx">newer</span>
        <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">newest</span><span class="p">)</span> <span class="k">if</span> <span class="o">--</span><span class="nx">cnt</span> <span class="o">==</span> <span class="mi">0</span>
      
      
    </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>This is a synchronous version of the above function.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="vi">@newestSync = </span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">others</span><span class="p">...)</span> <span class="o">=&gt;</span>
  <span class="nv">newest = </span><span class="kc">true</span>
  <span class="k">for</span> <span class="nx">otherFile</span> <span class="k">in</span> <span class="nx">others</span>
    <span class="nx">newest</span> <span class="o">&amp;&amp;=</span> <span class="nx">@newer</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">otherFile</span>
  <span class="nx">newest</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 